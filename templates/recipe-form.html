{{define "recipe-form-content"}}
<div class="form-container">
    <div class="form-header">
        <h1>
            {{if .Recipe}}
                <i class="fas fa-edit"></i> Edit Recipe
            {{else}}
                <i class="fas fa-plus"></i> New Recipe
            {{end}}
        </h1>
    </div>
    
    <form action="{{if .Recipe}}/recipe/{{.Recipe.ID}}/edit{{else}}/api/recipes{{end}}" method="POST" class="recipe-form" enctype="multipart/form-data">
        
        <div class="form-section">
            <h3>Recipe Images</h3>
            
            {{if .Recipe}}
                {{if .Recipe.Images}}
                    <div class="existing-images">
                        <h4>Current Images</h4>
                        <div class="image-gallery">
                            {{range .Recipe.Images}}
                                <div class="image-item" data-image-id="{{.ID}}">
                                    <img src="/uploads/{{.Filename}}" alt="{{.Caption}}" class="recipe-image-preview">
                                    <div class="image-controls">
                                        <input type="text" value="{{.Caption}}" placeholder="Image caption" class="image-caption">
                                        <button type="button" class="btn btn-danger btn-sm delete-image" data-image-id="{{.ID}}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {{end}}
                        </div>
                    </div>
                {{end}}
            {{end}}
            
            <div class="image-upload-section">
                <label for="recipe_images">Add New Images</label>
                <input type="file" id="recipe_images" name="recipe_images" multiple accept="image/*" class="form-control">
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> 
                    You can select multiple images. Supported formats: JPG, PNG, GIF. Max size: 5MB per image.
                </div>
                
                <div id="image-preview-container" class="image-preview-container"></div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-group">
                <label for="title">Recipe Title *</label>
                <input type="text" id="title" name="title" class="form-control" 
                       value="{{if .Recipe}}{{.Recipe.Title}}{{end}}" required>
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" class="form-control" rows="3" 
                          placeholder="Brief description of your recipe">{{if .Recipe}}{{.Recipe.Description}}{{end}}</textarea>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Recipe Details</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="prep_time">Prep Time (minutes)</label>
                    <input type="number" id="prep_time" name="prep_time" class="form-control" 
                           value="{{if .Recipe}}{{.Recipe.PrepTime}}{{end}}" min="0">
                </div>
                
                <div class="form-group">
                    <label for="cook_time">Cook Time (minutes)</label>
                    <input type="number" id="cook_time" name="cook_time" class="form-control" 
                           value="{{if .Recipe}}{{.Recipe.CookTime}}{{end}}" min="0">
                </div>
                
                <div class="form-group">
                    <label for="servings">Servings</label>
                    <input type="number" id="servings" name="servings" class="form-control" 
                           value="{{if .Recipe}}{{.Recipe.Servings}}{{end}}" min="1">
                </div>
                
                <div class="form-group">
                    <label for="serving_unit">Serving Unit</label>
                    <select id="serving_unit" name="serving_unit" class="form-control">
                        <option value="people">People</option>
                        <option value="servings">Servings</option>
                        <option value="portions">Portions</option>
                        <option value="pieces">Pieces</option>
                        <option value="slices">Slices</option>
                        <option value="cups">Cups</option>
                        <option value="bowls">Bowls</option>
                        <option value="glasses">Glasses</option>
                        <option value="liters">Liters</option>
                        <option value="ml">Milliliters</option>
                        <option value="kg">Kilograms</option>
                        <option value="g">Grams</option>
                        <option value="dozen">Dozen</option>
                        <option value="cookies">Cookies</option>
                        <option value="muffins">Muffins</option>
                        <option value="pancakes">Pancakes</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="flex-between mb-3">
                <h3>Ingredients</h3>
                <button type="button" id="add-new-ingredient-btn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-plus-circle"></i> Add New Ingredient
                </button>
            </div>
            <div id="ingredients-container">
                {{if .Recipe}}
                    {{range $index, $ingredient := .Recipe.Ingredients}}
                        <div class="ingredient-row" data-ingredient-id="{{$ingredient.IngredientID}}" data-quantity="{{$ingredient.Quantity}}" data-unit="{{$ingredient.Unit}}">
                            <select name="ingredient_{{$index}}" class="form-control ingredient-select" required>
                                <option value="">Select ingredient...</option>
                                {{range $.Ingredients}}
                                    <option value="{{.ID}}">{{.Name}}</option>
                                {{end}}
                            </select>
                            <input type="number" name="quantity_{{$index}}" class="form-control quantity-input" 
                                   placeholder="Quantity" step="0.1" min="0" value="{{$ingredient.Quantity}}" required>
                            <select name="unit_{{$index}}" class="form-control unit-select" required>
                                <option value="">Unit...</option>
                                <optgroup label="Volume">
                                    <option value="tsp">Teaspoon</option>
                                    <option value="tbsp">Tablespoon</option>
                                    <option value="cup">Cup</option>
                                    <option value="ml">Milliliter</option>
                                    <option value="l">Liter</option>
                                    <option value="fl oz">Fluid Ounce</option>
                                </optgroup>
                                <optgroup label="Weight">
                                    <option value="g">Gram</option>
                                    <option value="kg">Kilogram</option>
                                    <option value="oz">Ounce</option>
                                    <option value="lb">Pound</option>
                                </optgroup>
                                <optgroup label="Count">
                                    <option value="piece">Piece</option>
                                    <option value="clove">Clove</option>
                                    <option value="slice">Slice</option>
                                    <option value="can">Can</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="pinch">Pinch</option>
                                    <option value="dash">Dash</option>
                                    <option value="to taste">To taste</option>
                                </optgroup>
                            </select>
                            <button type="button" class="btn btn-danger btn-sm remove-ingredient">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {{end}}
                {{end}}
            </div>
            
            <button type="button" id="add-ingredient" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Ingredient
            </button>
        </div>
        
        <div class="form-section">
            <h3>Tags</h3>
            
            <div class="tags-selection">
                <label>Select Categories/Tags (click to toggle)</label>
                <div class="tag-filters">
                    {{range .Tags}}
                        <button type="button" class="tag-filter" data-tag-id="{{.ID}}" data-tag-name="{{.Name}}">
                            {{.Name}}
                        </button>
                        <input type="checkbox" id="tag_{{.ID}}" name="tags" value="{{.ID}}" class="hidden-checkbox"
                               {{if $.Recipe}}
                                   {{$currentTagID := .ID}}
                                   {{range $.Recipe.Tags}}
                                       {{if eq .ID $currentTagID}}checked{{end}}
                                   {{end}}
                               {{end}}>
                    {{end}}
                </div>
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> 
                    Click on tags to select/deselect them for your recipe.
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Instructions</h3>
            
            <div class="form-group">
                <label for="instructions">Cooking Instructions *</label>
                <textarea id="instructions" name="instructions" class="form-control instructions-textarea" rows="22" 
                          placeholder="Step-by-step cooking instructions" required>{{if .Recipe}}{{.Recipe.Instructions}}{{end}}</textarea>
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{{if .Recipe}}/recipe/{{.Recipe.ID}}{{else}}/recipes{{end}}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 
                {{if .Recipe}}Update Recipe{{else}}Save Recipe{{end}}
            </button>
        </div>
    </form>
</div>

<!-- New Ingredient Modal -->
<div id="ingredient-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Add New Ingredient</h3>
            <button type="button" class="modal-close" onclick="closeIngredientModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="new-ingredient-form">
                <div class="form-group">
                    <label for="new-ingredient-name">Ingredient Name *</label>
                    <input type="text" id="new-ingredient-name" class="form-control" 
                           placeholder="e.g., Olive Oil, Chicken Breast, etc." required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIngredientModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Ingredient
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let ingredientCounter = {{if .Recipe}}{{len .Recipe.Ingredients}}{{else}}0{{end}};
    let allIngredients = [
        {{range .Ingredients}}
            {id: {{.ID}}, name: "{{.Name}}"},
        {{end}}
    ];
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize remove buttons for existing ingredient rows
        document.querySelectorAll('.remove-ingredient').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.ingredient-row').remove();
            });
        });
        
        // Set ingredient and unit selections for existing recipe ingredients
        document.querySelectorAll('.ingredient-row').forEach(row => {
            const ingredientId = row.dataset.ingredientId;
            const unit = row.dataset.unit;
            
            if (ingredientId) {
                const ingredientSelect = row.querySelector('.ingredient-select');
                if (ingredientSelect) {
                    ingredientSelect.value = ingredientId;
                }
            }
            
            if (unit) {
                const unitSelect = row.querySelector('.unit-select');
                if (unitSelect) {
                    unitSelect.value = unit;
                }
            }
        });
        
        // Initialize tag buttons
        document.querySelectorAll('.tag-filter').forEach(button => {
            const tagId = button.dataset.tagId;
            const checkbox = document.getElementById('tag_' + tagId);
            
            // Set initial state based on checkbox (for edit mode)
            if (checkbox && checkbox.checked) {
                button.classList.add('active');
            }
            
            // Add click handler
            button.addEventListener('click', function() {
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    button.classList.toggle('active', checkbox.checked);
                }
            });
        });
        
        // Set serving unit value
        const servingUnitSelect = document.getElementById('serving_unit');
        const currentValue = '{{if .Recipe}}{{.Recipe.ServingUnit}}{{else}}people{{end}}';
        if (servingUnitSelect && currentValue) {
            servingUnitSelect.value = currentValue;
        }
    });
    
    document.getElementById('add-ingredient').addEventListener('click', function() {
        addIngredientRow();
    });
    
    // New ingredient modal functionality
    document.getElementById('add-new-ingredient-btn').addEventListener('click', function() {
        openIngredientModal();
    });
    
    document.getElementById('new-ingredient-form').addEventListener('submit', function(e) {
        e.preventDefault();
        createNewIngredient();
    });
    
    function openIngredientModal() {
        const modal = document.getElementById('ingredient-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.getElementById('new-ingredient-name').focus();
    }
    
    function closeIngredientModal() {
        const modal = document.getElementById('ingredient-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.getElementById('new-ingredient-name').value = '';
    }
    
    function createNewIngredient() {
        const name = document.getElementById('new-ingredient-name').value.trim();
        
        if (!name) {
            alert('Ingredient name is required');
            return;
        }
        
        // Check if ingredient already exists
        if (allIngredients.some(ing => ing.name.toLowerCase() === name.toLowerCase())) {
            alert('This ingredient already exists');
            return;
        }
        
        // Show loading state
        const submitBtn = document.querySelector('#new-ingredient-form button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        submitBtn.disabled = true;
        
        // Create the ingredient via API
        fetch('/api/ingredients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'name=' + encodeURIComponent(name)
        })
        .then(response => {
            if (response.ok) {
                // Add to local array (we'll use a temporary negative ID)
                const newId = Math.max(...allIngredients.map(i => i.id)) + 1;
                allIngredients.push({id: newId, name: name});
                
                // Update all ingredient selects
                updateIngredientSelects();
                
                // Close modal
                closeIngredientModal();
                
                // Show success message
                showToast('Ingredient "' + name + '" added successfully!', 'success');
            } else {
                throw new Error('Failed to create ingredient');
            }
        })
        .catch(error => {
            alert('Error creating ingredient: ' + error.message);
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }
    
    function updateIngredientSelects() {
        const selects = document.querySelectorAll('.ingredient-select');
        selects.forEach(select => {
            const currentValue = select.value;
            
            // Clear options
            select.innerHTML = '<option value="">Select ingredient...</option>';
            
            // Add all ingredients
            allIngredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.id;
                option.textContent = ingredient.name;
                if (ingredient.id == currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }
    
    // Close modal when clicking outside
    document.getElementById('ingredient-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeIngredientModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('ingredient-modal').classList.contains('hidden')) {
            closeIngredientModal();
        }
    });
    
    function addIngredientRow() {
        const container = document.getElementById('ingredients-container');
        const row = document.createElement('div');
        row.className = 'ingredient-row';
        
        let ingredientOptions = '<option value="">Select ingredient...</option>';
        allIngredients.forEach(ingredient => {
            ingredientOptions += `<option value="${ingredient.id}">${ingredient.name}</option>`;
        });
        
        row.innerHTML = `
            <select name="ingredient_${ingredientCounter}" class="form-control ingredient-select" required>
                ${ingredientOptions}
            </select>
            <input type="number" name="quantity_${ingredientCounter}" class="form-control quantity-input" 
                   placeholder="Quantity" step="0.1" min="0" required>
            <select name="unit_${ingredientCounter}" class="form-control unit-select" required>
                <option value="">Unit...</option>
                <optgroup label="Volume">
                    <option value="tsp">Teaspoon</option>
                    <option value="tbsp">Tablespoon</option>
                    <option value="cup">Cup</option>
                    <option value="ml">Milliliter</option>
                    <option value="l">Liter</option>
                    <option value="fl oz">Fluid Ounce</option>
                </optgroup>
                <optgroup label="Weight">
                    <option value="g">Gram</option>
                    <option value="kg">Kilogram</option>
                    <option value="oz">Ounce</option>
                    <option value="lb">Pound</option>
                </optgroup>
                <optgroup label="Count">
                    <option value="piece">Piece</option>
                    <option value="clove">Clove</option>
                    <option value="slice">Slice</option>
                    <option value="can">Can</option>
                </optgroup>
                <optgroup label="Other">
                    <option value="pinch">Pinch</option>
                    <option value="dash">Dash</option>
                    <option value="to taste">To taste</option>
                </optgroup>
            </select>
            <button type="button" class="btn btn-danger btn-sm remove-ingredient">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(row);
        ingredientCounter++;
        
        // Add event listener to remove button
        row.querySelector('.remove-ingredient').addEventListener('click', function() {
            row.remove();
        });
    }
    
    // Image upload preview functionality
    document.getElementById('recipe_images').addEventListener('change', function(e) {
        const files = e.target.files;
        const container = document.getElementById('image-preview-container');
        container.innerHTML = '';
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview-item';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview" class="image-preview">
                        <input type="text" name="image_captions" placeholder="Caption for this image" class="form-control image-caption-input">
                        <button type="button" class="btn btn-danger btn-sm remove-preview" onclick="removeImagePreview(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            }
        }
    });
    
    // Delete existing image functionality
    document.querySelectorAll('.delete-image').forEach(button => {
        button.addEventListener('click', function() {
            const imageId = this.dataset.imageId;
            const imageItem = this.closest('.image-item');
            
            if (confirm('Are you sure you want to delete this image?')) {
                fetch(`/api/images/${imageId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        imageItem.remove();
                        showToast('Image deleted successfully', 'success');
                    } else {
                        alert('Failed to delete image');
                    }
                })
                .catch(error => {
                    alert('Error deleting image: ' + error.message);
                });
            }
        });
    });
    
    function removeImagePreview(button) {
        button.closest('.image-preview-item').remove();
        // Reset file input to update the file list
        const fileInput = document.getElementById('recipe_images');
        fileInput.value = '';
    }
</script>
{{end}}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Recipe Book</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <div class="nav-overlay" id="navOverlay"></div>

    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <a href="/recipes"><i class="fas fa-utensils"></i> Recipe Book</a>
            </div>
            
            <!-- Mobile menu toggle button -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation menu" aria-expanded="false">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            
            <!-- Navigation links -->
            <div class="nav-links" id="navLinks">
                <a href="/recipes" class="nav-link">
                    <i class="fas fa-list"></i> <span>Recipes</span>
                </a>
                <a href="/ingredients" class="nav-link">
                    <i class="fas fa-leaf"></i> <span>Ingredients</span>
                </a>
                <a href="/tags" class="nav-link">
                    <i class="fas fa-tags"></i> <span>Tags</span>
                </a>
                
                {{if .IsLoggedIn}}
                    <div class="user-menu">
                        <div class="username">
                            <i class="fas fa-user"></i> <span>{{.User.Username}}</span>
                        </div>
                        <form action="/api/logout" method="POST">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                            </button>
                        </form>
                    </div>
                {{else}}
                    <div class="auth-buttons">
                        <a href="/login" class="btn btn-secondary">
                            <i class="fas fa-sign-in-alt"></i> <span>Login</span>
                        </a>
                        <a href="/register" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> <span>Register</span>
                        </a>
                    </div>
                {{end}}
            </div>
        </div>
    </nav>

    <div class="container">
        {{if .Error}}
            <div class="alert alert-error">
                <i class="fas fa-exclamation-triangle"></i>
                {{.Error}}
            </div>
        {{end}}
        
        {{if .Message}}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                {{.Message}}
            </div>
        {{end}}

        {{template "recipe-form-content" .}}
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
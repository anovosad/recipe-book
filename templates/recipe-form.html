{{define "recipe-form-content"}}
<div class="form-container">
    <div class="form-header">
        <h1>
            {{if .Recipe}}
                <i class="fas fa-edit"></i> Edit Recipe
            {{else}}
                <i class="fas fa-plus"></i> New Recipe
            {{end}}
        </h1>
    </div>
    
    <form id="recipeForm" class="recipe-form" enctype="multipart/form-data">
        
        <div class="form-section">
            <h3>Recipe Images</h3>
            
            {{if .Recipe}}
                {{if .Recipe.Images}}
                    <div class="existing-images">
                        <h4>Current Images</h4>
                        <div class="image-gallery">
                            {{range .Recipe.Images}}
                                <div class="image-item" data-image-id="{{.ID}}">
                                    <img src="/uploads/{{.Filename}}" alt="{{.Caption}}" class="recipe-image-preview">
                                    <div class="image-controls">
                                        <input type="text" value="{{.Caption}}" placeholder="Image caption" class="image-caption">
                                        <button type="button" class="btn btn-danger btn-sm delete-image" data-image-id="{{.ID}}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {{end}}
                        </div>
                    </div>
                {{end}}
            {{end}}
            
            <div class="image-upload-section">
                <label for="recipe_images">Add New Images</label>
                <input type="file" id="recipe_images" name="recipe_images" multiple accept="image/*" class="form-control">
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> 
                    You can select multiple images. Supported formats: JPG, PNG, GIF. Max size: 5MB per image.
                </div>
                
                <div id="image-preview-container" class="image-preview-container"></div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-group">
                <label for="title">Recipe Title *</label>
                <input type="text" id="title" name="title" class="form-control" 
                       value="{{if .Recipe}}{{.Recipe.Title}}{{end}}" required>
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" class="form-control" rows="3" 
                          placeholder="Brief description of your recipe">{{if .Recipe}}{{.Recipe.Description}}{{end}}</textarea>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Recipe Details</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="prep_time">Prep Time (minutes)</label>
                    <input type="number" id="prep_time" name="prep_time" class="form-control" 
                           value="{{if .Recipe}}{{.Recipe.PrepTime}}{{end}}" min="0">
                </div>
                
                <div class="form-group">
                    <label for="cook_time">Cook Time (minutes)</label>
                    <input type="number" id="cook_time" name="cook_time" class="form-control" 
                           value="{{if .Recipe}}{{.Recipe.CookTime}}{{end}}" min="0">
                </div>
                
                <div class="form-group">
                    <label for="servings">Servings</label>
                    <input type="number" id="servings" name="servings" class="form-control" 
                           value="{{if .Recipe}}{{.Recipe.Servings}}{{end}}" min="1">
                </div>
                
                <div class="form-group">
                    <label for="serving_unit">Serving Unit</label>
                    <select id="serving_unit" name="serving_unit" class="form-control">
                        <option value="people">People</option>
                        <option value="servings">Servings</option>
                        <option value="portions">Portions</option>
                        <option value="pieces">Pieces</option>
                        <option value="slices">Slices</option>
                        <option value="cups">Cups</option>
                        <option value="bowls">Bowls</option>
                        <option value="glasses">Glasses</option>
                        <option value="liters">Liters</option>
                        <option value="ml">Milliliters</option>
                        <option value="kg">Kilograms</option>
                        <option value="g">Grams</option>
                        <option value="dozen">Dozen</option>
                        <option value="cookies">Cookies</option>
                        <option value="muffins">Muffins</option>
                        <option value="pancakes">Pancakes</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="flex-between mb-3">
                <h3>Ingredients</h3>
                <button type="button" id="add-new-ingredient-btn" class="btn btn-secondary btn-sm">
                    <i class="fas fa-plus-circle"></i> Add New Ingredient
                </button>
            </div>
            <div id="ingredients-container">
                {{if .Recipe}}
                    {{if .Recipe.Ingredients}}
                        {{range .Recipe.Ingredients}}
                            <div class="ingredient-row">
                                <input type="hidden" name="existing_ingredient_id[]" value="{{.IngredientID}}">
                                <input type="hidden" name="existing_quantity[]" value="{{.Quantity}}">
                                <input type="hidden" name="existing_unit[]" value="{{.Unit}}">
                                
                                <select name="ingredient_select[]" class="form-control ingredient-select" required>
                                    <option value="">Select ingredient...</option>
                                    {{$currentIngredientID := .IngredientID}}
                                    {{range $.Ingredients}}
                                        <option value="{{.ID}}" {{if eq .ID $currentIngredientID}}selected{{end}}>{{.Name}}</option>
                                    {{end}}
                                </select>
                                
                                <input type="number" name="quantity_input[]" class="form-control quantity-input" 
                                       placeholder="Quantity" step="0.1" min="0" value="{{.Quantity}}" required>
                                
                                <select name="unit_select[]" class="form-control unit-select" required>
                                    <option value="">Unit...</option>
                                    {{$currentUnit := .Unit}}
                                    <optgroup label="Volume">
                                        <option value="tsp" {{if eq $currentUnit "tsp"}}selected{{end}}>Teaspoon</option>
                                        <option value="tbsp" {{if eq $currentUnit "tbsp"}}selected{{end}}>Tablespoon</option>
                                        <option value="cup" {{if eq $currentUnit "cup"}}selected{{end}}>Cup</option>
                                        <option value="ml" {{if eq $currentUnit "ml"}}selected{{end}}>Milliliter</option>
                                        <option value="l" {{if eq $currentUnit "l"}}selected{{end}}>Liter</option>
                                        <option value="fl oz" {{if eq $currentUnit "fl oz"}}selected{{end}}>Fluid Ounce</option>
                                    </optgroup>
                                    <optgroup label="Weight">
                                        <option value="g" {{if eq $currentUnit "g"}}selected{{end}}>Gram</option>
                                        <option value="kg" {{if eq $currentUnit "kg"}}selected{{end}}>Kilogram</option>
                                        <option value="oz" {{if eq $currentUnit "oz"}}selected{{end}}>Ounce</option>
                                        <option value="lb" {{if eq $currentUnit "lb"}}selected{{end}}>Pound</option>
                                    </optgroup>
                                    <optgroup label="Count">
                                        <option value="piece" {{if eq $currentUnit "piece"}}selected{{end}}>Piece</option>
                                        <option value="clove" {{if eq $currentUnit "clove"}}selected{{end}}>Clove</option>
                                        <option value="slice" {{if eq $currentUnit "slice"}}selected{{end}}>Slice</option>
                                        <option value="can" {{if eq $currentUnit "can"}}selected{{end}}>Can</option>
                                    </optgroup>
                                    <optgroup label="Other">
                                        <option value="pinch" {{if eq $currentUnit "pinch"}}selected{{end}}>Pinch</option>
                                        <option value="dash" {{if eq $currentUnit "dash"}}selected{{end}}>Dash</option>
                                        <option value="to taste" {{if eq $currentUnit "to taste"}}selected{{end}}>To taste</option>
                                    </optgroup>
                                </select>
                                
                                <button type="button" class="btn btn-danger btn-sm remove-ingredient">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {{end}}
                    {{end}}
                {{end}}
            </div>
            
            <button type="button" id="add-ingredient" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Ingredient
            </button>
        </div>
        
        <div class="form-section">
            <h3>Tags</h3>
            
            <div class="tags-selection">
                <label>Select Categories/Tags (click to toggle)</label>
                <div class="tag-filters">
                    {{range .Tags}}
                        <button type="button" class="tag-filter" data-tag-id="{{.ID}}" data-tag-name="{{.Name}}">
                            {{.Name}}
                        </button>
                        <input type="checkbox" id="tag_{{.ID}}" name="tags" value="{{.ID}}" class="hidden-checkbox"
                               {{if $.Recipe}}
                                   {{$currentTagID := .ID}}
                                   {{range $.Recipe.Tags}}
                                       {{if eq .ID $currentTagID}}checked{{end}}
                                   {{end}}
                               {{end}}>
                    {{end}}
                </div>
                <div class="help-text">
                    <i class="fas fa-info-circle"></i> 
                    Click on tags to select/deselect them for your recipe.
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Instructions</h3>
            
            <div class="form-group">
                <label for="instructions">Cooking Instructions *</label>
                <textarea id="instructions" name="instructions" class="form-control instructions-textarea" rows="22" 
                          placeholder="Step-by-step cooking instructions" required>{{if .Recipe}}{{.Recipe.Instructions}}{{end}}</textarea>
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{{if .Recipe}}/recipe/{{.Recipe.ID}}{{else}}/recipes{{end}}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> 
                {{if .Recipe}}Update Recipe{{else}}Save Recipe{{end}}
            </button>
        </div>
    </form>
</div>

<!-- New Ingredient Modal -->
<div id="ingredient-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Add New Ingredient</h3>
            <button type="button" class="modal-close" onclick="closeIngredientModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="new-ingredient-form">
                <div class="form-group">
                    <label for="new-ingredient-name">Ingredient Name *</label>
                    <input type="text" id="new-ingredient-name" class="form-control" 
                           placeholder="e.g., Olive Oil, Chicken Breast, etc." required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIngredientModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Ingredient
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let ingredientCounter = 0;
    let allIngredients = [
        {{range .Ingredients}}
            {id: {{.ID}}, name: "{{.Name}}"},
        {{end}}
    ];
    const isEditMode = {{if .Recipe}}true{{else}}false{{end}};
    const recipeId = {{if .Recipe}}{{.Recipe.ID}}{{else}}null{{end}};
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeRecipeForm();
        initializeTagButtons();
        setServingUnitValue();
        initializeImageDeletion();
        initializeImageUpload();
        
        // Initialize existing ingredient rows
        document.querySelectorAll('.ingredient-row .remove-ingredient').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.ingredient-row').remove();
            });
        });
    });
    
    function initializeRecipeForm() {
        const form = document.getElementById('recipeForm');
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                const formData = new FormData(this);
                const url = isEditMode ? `/recipe/${recipeId}/edit` : '/api/recipes';
                
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1000);
                } else {
                    alert(data.error || 'Failed to save recipe');
                }
            } catch (error) {
                console.error('Recipe save error:', error);
                alert('Failed to save recipe. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
        
        document.getElementById('add-ingredient').addEventListener('click', addIngredientRow);
        document.getElementById('add-new-ingredient-btn').addEventListener('click', openIngredientModal);
        document.getElementById('new-ingredient-form').addEventListener('submit', createNewIngredient);
    }
    
    function initializeTagButtons() {
        document.querySelectorAll('.tag-filter').forEach(button => {
            const tagId = button.dataset.tagId;
            const checkbox = document.getElementById('tag_' + tagId);
            
            if (checkbox && checkbox.checked) {
                button.classList.add('active');
            }
            
            button.addEventListener('click', function() {
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    button.classList.toggle('active', checkbox.checked);
                }
            });
        });
    }
    
    function setServingUnitValue() {
        const servingUnitSelect = document.getElementById('serving_unit');
        const currentValue = '{{if .Recipe}}{{.Recipe.ServingUnit}}{{else}}people{{end}}';
        if (servingUnitSelect && currentValue) {
            servingUnitSelect.value = currentValue;
        }
    }
    
    function initializeImageDeletion() {
        document.querySelectorAll('.delete-image').forEach(button => {
            button.addEventListener('click', async function() {
                const imageId = this.dataset.imageId;
                const imageItem = this.closest('.image-item');
                
                if (confirm('Are you sure you want to delete this image?')) {
                    const originalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    try {
                        const response = await fetch(`/api/images/${imageId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            imageItem.style.opacity = '0';
                            setTimeout(() => imageItem.remove(), 300);
                            alert('Image deleted successfully');
                        } else {
                            alert('Failed to delete image');
                        }
                    } catch (error) {
                        console.error('Image deletion error:', error);
                        alert('Failed to delete image');
                    } finally {
                        this.disabled = false;
                        this.innerHTML = originalText;
                    }
                }
            });
        });
    }
    
    function initializeImageUpload() {
        document.getElementById('recipe_images').addEventListener('change', function(e) {
            const files = e.target.files;
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview-item';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview" class="image-preview">
                            <input type="text" name="image_captions" placeholder="Caption for this image" class="form-control image-caption-input">
                            <button type="button" class="btn btn-danger btn-sm remove-preview" onclick="removeImagePreview(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        container.appendChild(previewDiv);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    }
    
    function openIngredientModal() {
        const modal = document.getElementById('ingredient-modal');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.getElementById('new-ingredient-name').focus();
    }
    
    function closeIngredientModal() {
        const modal = document.getElementById('ingredient-modal');
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.getElementById('new-ingredient-name').value = '';
    }
    
    async function createNewIngredient(e) {
        e.preventDefault();
        
        const form = e.target;
        const nameInput = form.querySelector('#new-ingredient-name');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('Ingredient name is required');
            return;
        }
        
        if (allIngredients.some(ing => ing.name.toLowerCase() === name.toLowerCase())) {
            alert('This ingredient already exists');
            return;
        }
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        
        try {
            const formData = new FormData();
            formData.append('name', name);
            
            const response = await fetch('/api/ingredients', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                const newId = Math.max(...allIngredients.map(i => i.id), 0) + 1;
                allIngredients.push({id: newId, name: name});
                updateIngredientSelects();
                closeIngredientModal();
                alert(data.message);
            } else {
                alert(data.error || 'Failed to create ingredient');
            }
        } catch (error) {
            console.error('Ingredient creation error:', error);
            alert('Failed to create ingredient');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
    
    function updateIngredientSelects() {
        const selects = document.querySelectorAll('.ingredient-select');
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select ingredient...</option>';
            allIngredients.forEach(ingredient => {
                const option = document.createElement('option');
                option.value = ingredient.id;
                option.textContent = ingredient.name;
                if (ingredient.id == currentValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });
    }
    
    function addIngredientRow() {
        const container = document.getElementById('ingredients-container');
        const row = document.createElement('div');
        row.className = 'ingredient-row';
        
        let ingredientOptions = '<option value="">Select ingredient...</option>';
        allIngredients.forEach(ingredient => {
            ingredientOptions += `<option value="${ingredient.id}">${ingredient.name}</option>`;
        });
        
        row.innerHTML = `
            <select name="new_ingredient_id[]" class="form-control ingredient-select" required>
                ${ingredientOptions}
            </select>
            <input type="number" name="new_quantity[]" class="form-control quantity-input" 
                   placeholder="Quantity" step="0.1" min="0" required>
            <select name="new_unit[]" class="form-control unit-select" required>
                <option value="">Unit...</option>
                <optgroup label="Volume">
                    <option value="tsp">Teaspoon</option>
                    <option value="tbsp">Tablespoon</option>
                    <option value="cup">Cup</option>
                    <option value="ml">Milliliter</option>
                    <option value="l">Liter</option>
                    <option value="fl oz">Fluid Ounce</option>
                </optgroup>
                <optgroup label="Weight">
                    <option value="g">Gram</option>
                    <option value="kg">Kilogram</option>
                    <option value="oz">Ounce</option>
                    <option value="lb">Pound</option>
                </optgroup>
                <optgroup label="Count">
                    <option value="piece">Piece</option>
                    <option value="clove">Clove</option>
                    <option value="slice">Slice</option>
                    <option value="can">Can</option>
                </optgroup>
                <optgroup label="Other">
                    <option value="pinch">Pinch</option>
                    <option value="dash">Dash</option>
                    <option value="to taste">To taste</option>
                </optgroup>
            </select>
            <button type="button" class="btn btn-danger btn-sm remove-ingredient">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(row);
        
        row.querySelector('.remove-ingredient').addEventListener('click', function() {
            row.remove();
        });
    }
    
    function removeImagePreview(button) {
        button.closest('.image-preview-item').remove();
        const fileInput = document.getElementById('recipe_images');
        fileInput.value = '';
    }
    
    // Close modal events
    document.getElementById('ingredient-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeIngredientModal();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !document.getElementById('ingredient-modal').classList.contains('hidden')) {
            closeIngredientModal();
        }
    });
</script>
{{end}}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Recipe Book</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <div class="nav-overlay" id="navOverlay"></div>

    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <a href="/recipes"><i class="fas fa-utensils"></i> Recipe Book</a>
            </div>
            
            <!-- Mobile menu toggle button -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation menu" aria-expanded="false">
                <div class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            
            <!-- Navigation links -->
            <div class="nav-links" id="navLinks">
                <a href="/recipes" class="nav-link">
                    <i class="fas fa-list"></i> <span>Recipes</span>
                </a>
                <a href="/ingredients" class="nav-link">
                    <i class="fas fa-leaf"></i> <span>Ingredients</span>
                </a>
                <a href="/tags" class="nav-link">
                    <i class="fas fa-tags"></i> <span>Tags</span>
                </a>
                
                {{if .IsLoggedIn}}
                    <div class="user-menu">
                        <div class="username">
                            <i class="fas fa-user"></i> <span>{{.User.Username}}</span>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                        </button>
                    </div>
                {{else}}
                    <div class="auth-buttons">
                        <a href="/login" class="btn btn-secondary">
                            <i class="fas fa-sign-in-alt"></i> <span>Login</span>
                        </a>
                        <a href="/register" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> <span>Register</span>
                        </a>
                    </div>
                {{end}}
            </div>
        </div>
    </nav>

    <div class="container">
        {{if .Error}}
            <div class="alert alert-error">
                <i class="fas fa-exclamation-triangle"></i>
                {{.Error}}
            </div>
        {{end}}
        
        {{if .Message}}
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                {{.Message}}
            </div>
        {{end}}

        {{template "recipe-form-content" .}}
    </div>

    <script src="/static/app.js"></script>
</body>
</html>